<!-- ==================================================================== -->
<!-- Ant build file for Freenet-ext.                                      -->
<!-- Please download and install ant from http://ant.apache.org/          -->
<!-- ==================================================================== -->
<project name="Freenet-ext" default="jar">
	<property name="build" location="build_dir"/>
	<property name="jar.location" location="freenet-ext.jar"/>
	<property name="svn.revision" value="@custom@"/>
	<property name="javac.target.version" value="1.5"/>

	<target name="init" description="Create build directory">
		<mkdir dir="${build}"/>
		<mkdir dir="${build}/freenet/node/"/>
		
		<!-- Update the Version file -->
		<replace file="ExtVersion.java">
			<replacefilter token="@custom@" value="${svn.revision}"/>
		</replace>
		<javac srcdir="." destdir="${build}" optimize="on" source="${javac.target.version}">
			<include name="ExtVersion.java"/>
		</javac>
	</target>

	<target name="fec-common" depends="init" description="build required classes for FEC">
		<ant antfile="build.xml" dir="../fec/common/"/>
	</target>
	
	<target name="fec" depends="fec-common" description="build the fecencoder/decoder plugins for fproxy.">
		<javac destdir="${build}" optimize="on" source="${javac.target.version}">
			<src path="../fec/fec_src"/>
			<classpath path="../fec/common/lib/onion-common.jar"/>
		</javac>

		<copy file="../fec/onion_LICENSE" todir="${build}"/>
		<copy todir="${build}">
			<fileset dir="../fec/fec_src">
				<include name="**/*.properties"/>
			</fileset>
			<fileset dir="../fec/">
				<include name="lib/"/>
			</fileset>
		</copy>
	</target>

	<target name="jcpuid" depends="init">
		<copy todir="${build}">
			<fileset dir="../jcpuid/lib" includes="freenet/**" />
		</copy>
	</target>

	<target name="bigint" depends="init">
		<copy todir="${build}">
			<fileset dir="../NativeBigInteger/lib" includes="net/**" />
		</copy>
	</target>

	<target name="nativethread" depends="init">
		<copy todir="${build}">
			<fileset dir="../NativeThread/lib" includes="freenet/**" />
		</copy>
	</target>
	
	<target name="bdb" depends="init" description="Build the BDB provider">
		<ant antfile="build.xml" dir="../bdb/" target="jar"/>
	</target>
	
	<target name="wrapper" depends="init" description="Build the java wrapper">
		<ant antfile="build.xml" target="jar" dir="../wrapper/">
			<!-- detect it! -->
			<property name="bits" value="32"/>
			<property name="javac.target.version" value="${javac.target.version}"/>
		</ant>
	</target>

	<target name="clean" depends="distclean"/>

	<target name="distclean" description="Cleanup the build directory">
		<ant antfile="build.xml" target="clean" dir="../fec/common/"/>
		<ant antfile="build.xml" target="clean" dir="../bdb/"/>
		<ant antfile="build.xml" target="clean" dir="../wrapper/">
			<!-- detect it! -->
			<property name="bits" value="32"/>
		</ant>
		<delete dir="${build}"/>
		<delete file="${jar.location}"/>
	</target>

	<target name="jar" depends="clean,fec,jcpuid,nativethread,bigint,bdb,wrapper" description="Create the jar file">
		<jar jarfile="${jar.location}" basedir="${build}" includes="**">
			<zipfileset src="../fec/common/lib/onion-common.jar"/>
			<zipfileset src="../bdb/build/lib/je.jar"/>
			<zipfileset src="../wrapper/lib/wrapper.jar"/>
		</jar>
	</target>
</project>
